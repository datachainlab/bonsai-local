name: release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
    branches:
      - docker-risc0-v3

jobs:
  test:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        profile: [release]
        features:
          - ""
          - "cuda"
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build docker tag
        id: image_tag
        shell: bash
        run: |
          set -euo pipefail
          tag='${{ github.ref_name }}'
          profile='${{ matrix.profile }}'
          features='${{ matrix.features }}'
          
          suffix=""
          # If the profile is not `release`, append -${profile}
          if [[ "${profile}" != "release" && -n "${profile}" ]]; then
            suffix="${suffix}-${profile}"
          fi
          
          # 1) Replace commas/whitespace (space, tab, line break) → ‘.’
          # 2) Compress consecutive ‘.’ to a single ‘.’
          # 3) Remove leading/trailing ‘.’
          sanitize_features() {
            local s
            s="$(printf '%s' "$1" | tr '[:space:],' '.' | tr -s '.')"
            s="${s#.}"; s="${s%.}"
            printf '%s' "$s"
          }
          
          if [[ -n "${features}" ]]; then
            features_sanitized="$(sanitize_features "${features_raw}")"
            if [[ -n "${features_sanitized}" ]]; then
              suffix="${suffix}-${features_sanitized}"
            fi
          fi
          
          result="${tag}${suffix}"
          
          echo "result=${result}" >> "$GITHUB_OUTPUT"
      - name: Build and push
        uses: docker/build-push-action@v6
        env:
          BUILDX_GIT_LABELS: 1
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            PROFILE=${{ matrix.profile }}
            FEATURES=${{ matrix.features }}
          tags: |
            ghcr.io/${{ github.repository }}/bonsai-local:${{ steps.image_tag.outputs.result }}
          # push: true
          load: true
          cache-to: type=gha,mode=max,scope=${{ github.repository }}-${{ matrix.profile }}-${{ matrix.features }}
          cache-from: type=gha,scope=${{ github.repository }}-${{ matrix.profile }}-${{ matrix.features }}
